generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String             @id @default(cuid())
  uid                   BigInt             @unique @default(autoincrement())
  email                 String             @unique
  passwordHash          String             @map("password_hash")
  name                  String
  phone                 String             @unique
  emergencyContact      String?            @map("emergency_contact")
  createdAt             DateTime           @default(now()) @map("created_at")
  updatedAt             DateTime           @updatedAt @map("updated_at")
  isAdmin               Boolean            @default(false) @map("is_admin")
  isMember              Boolean            @default(false) @map("is_member")
  skillLevel            String?            @map("skill_level")
  creditBalance         Float              @default(0) @map("credit_balance")
  notifyBookingConfirm  Boolean            @default(true) @map("notify_booking_confirm")
  notifyBookingReminder Boolean            @default(true) @map("notify_booking_reminder")
  notifyCancellation    Boolean            @default(true) @map("notify_cancellation")
  notifyLessonUpdates   Boolean            @default(true) @map("notify_lesson_updates")
  pendingEmail          String?            @map("pending_email")
  emailVerifyToken      String?            @map("email_verify_token")
  emailVerifyExpiry     DateTime?          @map("email_verify_expiry")
  avatarUrl             String?            @map("avatar_url")
  deletedAt             DateTime?          @map("deleted_at")
  bookings              Booking[]
  lessonRequests        LessonRequest[]
  monthlyPayments       MonthlyPayment[]
  notifications         Notification[]
  racketProfile         RacketProfile[]
  recurringBookings     RecurringBooking[]
  stringingOrders       StringingOrder[]
  lessonSessions        LessonSession[]    @relation("StudentLessons")
  shopOrders            ShopOrder[]
  absences              Absence[]
  replacementCredits    ReplacementCredit[]
  replacementBookings   ReplacementBooking[]
  gameSessions          GameSession[]
  sessionAttendances    SessionAttendance[]
  matchPlayers          MatchPlayer[]
  playerPoints          PlayerPoints[]
  playerProfile         PlayerProfile?
  teacher               Teacher?

  @@map("users")
}

model Court {
  id                Int                @id @default(autoincrement())
  name              String
  description       String?
  isActive          Boolean            @default(true) @map("is_active")
  hourlyRate        Float              @map("hourly_rate")
  bookings          Booking[]
  lessonSessions    LessonSession[]
  recurringBookings RecurringBooking[]
  gameSessions      GameSession[]

  @@map("courts")
}

model Booking {
  id                    String    @id @default(cuid())
  userId                String?   @map("user_id")
  courtId               Int       @map("court_id")
  sport                 String    @default("badminton")
  bookingDate           DateTime  @map("booking_date")
  startTime             String    @map("start_time")
  endTime               String    @map("end_time")
  totalAmount           Float     @map("total_amount")
  status                String    @default("pending")
  paymentStatus         String    @default("pending") @map("payment_status")
  paymentMethod         String?   @map("payment_method")
  paymentIntentId       String?   @map("payment_intent_id")
  stripeSessionId       String?   @map("stripe_session_id")
  paidAt                DateTime? @map("paid_at")
  paymentUserConfirmed  Boolean   @default(false) @map("payment_user_confirmed")
  guestName             String?   @map("guest_name")
  guestPhone            String?   @map("guest_phone")
  guestEmail            String?   @map("guest_email")
  cancelledAt           DateTime? @map("cancelled_at")
  creditRefunded        Float?    @map("credit_refunded")
  expirationWarningSent Boolean   @default(false) @map("expiration_warning_sent")
  expiredAt             DateTime? @map("expired_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  paymentScreenshotUrl       String?   @map("payment_screenshot_url")
  receiptVerificationStatus  String?   @map("receipt_verification_status") // pending_verification, approved, rejected
  verificationNotes          String?   @map("verification_notes")
  verifiedAt                 DateTime? @map("verified_at")
  verifiedBy                 String?   @map("verified_by")
  court                      Court     @relation(fields: [courtId], references: [id])
  user                       User?     @relation(fields: [userId], references: [id])

  @@index([bookingDate])
  @@index([userId])
  @@index([status])
  @@map("bookings")
}

model TimeSlot {
  id          Int    @id @default(autoincrement())
  slotTime    String @map("slot_time")
  displayName String @map("display_name")

  @@map("time_slots")
}

model RecurringBooking {
  id         String                    @id @default(cuid())
  courtId    Int                       @map("court_id")
  sport      String                    @default("badminton")
  dayOfWeek  Int                       @map("day_of_week")
  startTime  String                    @map("start_time")
  endTime    String                    @map("end_time")
  startDate  DateTime                  @map("start_date")
  endDate    DateTime?                 @map("end_date")
  label      String?
  userId     String?                   @map("user_id")
  guestName  String?                   @map("guest_name")
  guestPhone String?                   @map("guest_phone")
  hourlyRate Float?                    @map("hourly_rate")
  createdBy  String?                   @map("created_by")
  isActive   Boolean                   @default(true) @map("is_active")
  createdAt  DateTime                  @default(now()) @map("created_at")
  updatedAt  DateTime                  @updatedAt @map("updated_at")
  payments   RecurringBookingPayment[]
  court      Court                     @relation(fields: [courtId], references: [id])
  user       User?                     @relation(fields: [userId], references: [id])

  @@index([dayOfWeek])
  @@index([userId])
  @@index([isActive])
  @@map("recurring_bookings")
}

model RecurringBookingPayment {
  id                 String           @id @default(cuid())
  recurringBookingId String           @map("recurring_booking_id")
  month              Int
  year               Int
  amount             Float
  sessionsCount      Int              @map("sessions_count")
  status             String           @default("pending")
  paidAt             DateTime?        @map("paid_at")
  paymentMethod      String?          @map("payment_method")
  notes              String?
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")
  recurringBooking   RecurringBooking @relation(fields: [recurringBookingId], references: [id], onDelete: Cascade)

  @@unique([recurringBookingId, month, year])
  @@index([month, year])
  @@index([status])
  @@map("recurring_booking_payments")
}

model CoachAvailability {
  id           String    @id @default(cuid())
  dayOfWeek    Int       @map("day_of_week")
  startTime    String    @map("start_time")
  endTime      String    @map("end_time")
  isRecurring  Boolean   @default(true) @map("is_recurring")
  specificDate DateTime? @map("specific_date")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("coach_availability")
}

model LessonType {
  id          String   @id @default(cuid())
  name        String   @unique
  billingType String   @default("per_session") @map("billing_type")
  price       Float
  maxStudents Int      @default(1) @map("max_students")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("lesson_types")
}

model LessonSession {
  id                   String               @id @default(cuid())
  courtId              Int                  @map("court_id")
  teacherId            String?              @map("teacher_id")
  lessonDate           DateTime             @map("lesson_date")
  startTime            String               @map("start_time")
  endTime              String               @map("end_time")
  lessonType           String               @map("lesson_type")
  billingType          String               @default("per_session") @map("billing_type")
  duration             Float
  price                Float
  status               String               @default("scheduled")
  notes                String?
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")
  court                Court                @relation(fields: [courtId], references: [id])
  teacher              Teacher?             @relation(fields: [teacherId], references: [id])
  students             User[]               @relation("StudentLessons")
  absences             Absence[]
  replacementBookings  ReplacementBooking[]

  @@index([teacherId])
  @@map("lesson_sessions")
}

model MonthlyPayment {
  id            String               @id @default(cuid())
  userId        String               @map("user_id")
  month         Int
  year          Int
  totalAmount   Float                @map("total_amount")
  paidAmount    Float                @default(0) @map("paid_amount")
  bookingsCount Int                  @map("bookings_count")
  totalHours    Float                @map("total_hours")
  status        String               @default("unpaid")
  markedPaidBy  String?              @map("marked_paid_by")
  markedPaidAt  DateTime?            @map("marked_paid_at")
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")
  user          User                 @relation(fields: [userId], references: [id])
  transactions  PaymentTransaction[]

  @@unique([userId, month, year])
  @@map("monthly_payments")
}

model PaymentTransaction {
  id               String         @id @default(cuid())
  monthlyPaymentId String         @map("monthly_payment_id")
  amount           Float
  paymentMethod    String         @map("payment_method")
  reference        String?
  notes            String?
  recordedBy       String         @map("recorded_by")
  recordedAt       DateTime       @default(now()) @map("recorded_at")
  idempotencyKey   String?        @unique @map("idempotency_key")
  monthlyPayment   MonthlyPayment @relation(fields: [monthlyPaymentId], references: [id], onDelete: Cascade)

  @@map("payment_transactions")
}

model LessonRequest {
  id                String   @id @default(cuid())
  memberId          String   @map("member_id")
  requestedDate     DateTime @map("requested_date")
  requestedTime     String   @map("requested_time")
  lessonType        String   @map("lesson_type")
  requestedDuration Float    @default(1.5) @map("requested_duration")
  status            String   @default("pending")
  adminNotes        String?  @map("admin_notes")
  suggestedTime     String?  @map("suggested_time")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  member            User     @relation(fields: [memberId], references: [id])

  @@map("lesson_requests")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}

model TrialRequest {
  id                  String    @id @default(cuid())
  name                String
  phone               String
  email               String?
  preferredLessonType String    @map("preferred_lesson_type")
  preferredDate       DateTime? @map("preferred_date")
  preferredTime       String?   @map("preferred_time")
  message             String?
  status              String    @default("new")
  adminNotes          String?   @map("admin_notes")
  contactedAt         DateTime? @map("contacted_at")
  handledBy           String?   @map("handled_by")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@map("trial_requests")
}

model StringingOrder {
  id                     String    @id @default(cuid())
  userId                 String?   @map("user_id")
  stringName             String    @map("string_name")
  stringColor            String?   @map("string_color")
  price                  Int
  customerName           String    @map("customer_name")
  customerPhone          String    @map("customer_phone")
  customerEmail          String?   @map("customer_email")
  racketModel            String    @map("racket_model")
  racketModelCustom      String?   @map("racket_model_custom")
  tensionMain            Int       @map("tension_main")
  tensionCross           Int       @map("tension_cross")
  pickupDate             DateTime  @map("pickup_date")
  notes                  String?
  paymentMethod          String?   @map("payment_method")
  paymentUserConfirmed   Boolean   @default(false) @map("payment_user_confirmed")
  paymentStatus          String    @default("pending") @map("payment_status")
  markedPaidBy           String?   @map("marked_paid_by")
  markedPaidAt           DateTime? @map("marked_paid_at")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")
  paymentScreenshotUrl   String?   @map("payment_screenshot_url")
  uid                    BigInt    @unique @default(autoincrement())
  collectedAt            DateTime? @map("collected_at")
  inProgressAt           DateTime? @map("in_progress_at")
  isWalkIn               Boolean   @default(false) @map("is_walk_in")
  jobUid                 String?   @unique @map("job_uid")
  priceDefault           Int?      @map("price_default")
  priceFinal             Int?      @map("price_final")
  readyAt                DateTime? @map("ready_at")
  receivedAt             DateTime? @map("received_at")
  status                      String    @default("RECEIVED")
  receiptVerificationStatus   String?   @map("receipt_verification_status") // pending_verification, approved, rejected
  verificationNotes           String?   @map("verification_notes")
  verifiedAt                  DateTime? @map("verified_at")
  verifiedBy                  String?   @map("verified_by")
  user                        User?     @relation(fields: [userId], references: [id])

  @@map("stringing_orders")
}

model StringStock {
  id            String           @id @default(cuid())
  stringId      String           @map("string_id")
  color         String
  quantity      Int              @default(0)
  lowStockAlert Int              @default(3) @map("low_stock_alert")
  lastUpdatedBy String?          @map("last_updated_by")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  logs          StringStockLog[]

  @@unique([stringId, color])
  @@map("string_stocks")
}

model StringStockLog {
  id          String      @id @default(cuid())
  stockId     String      @map("stock_id")
  previousQty Int         @map("previous_qty")
  newQty      Int         @map("new_qty")
  changeType  String      @map("change_type")
  reason      String?
  orderId     String?     @map("order_id")
  changedBy   String?     @map("changed_by")
  createdAt   DateTime    @default(now()) @map("created_at")
  stock       StringStock @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@map("string_stock_logs")
}

model RacketProfile {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  brand         String
  model         String
  color         String
  weight        String
  swingWeight   String?   @map("swing_weight")
  shaftNumber   String?   @map("shaft_number")
  tensionMain   Int?      @map("tension_main")
  tensionCross  Int?      @map("tension_cross")
  purchasedDate DateTime? @map("purchased_date")
  isDefault     Boolean   @default(false) @map("is_default")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("racket_profiles")
}

model StringingMonthCounter {
  id      String @id @default(cuid())
  year    Int
  month   Int
  counter Int    @default(0)

  @@unique([year, month])
  @@map("stringing_month_counters")
}

model ShopProduct {
  id          String   @id @default(cuid())
  productId   String   @unique @map("product_id")
  category    String
  subcategory String?
  brand       String
  name        String
  fullName    String   @map("full_name")
  price       Float
  description String?
  specs       Json?
  image       String
  images      Json?
  colors      Json?
  colorImages Json?    @map("color_images")
  sizes       Json?
  inStock     Boolean  @default(true) @map("in_stock")
  stockCount  Int      @default(0) @map("stock_count")
  featured    Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@index([brand])
  @@index([inStock])
  @@map("shop_products")
}

model AuditLog {
  id         String   @id @default(cuid())
  adminId    String   @map("admin_id")
  adminEmail String   @map("admin_email")
  action     String
  targetType String   @map("target_type")
  targetId   String?  @map("target_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([adminId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("audit_logs")
}

enum ShopOrderStatus {
  PENDING_PAYMENT
  CONFIRMED
  PREPARING
  READY_FOR_PICKUP
  COMPLETED
  CANCELLED
}

model ShopOrder {
  id            String          @id @default(cuid())
  userId        String?         @map("user_id")
  customerName  String          @map("customer_name")
  customerPhone String          @map("customer_phone")
  customerEmail String?         @map("customer_email")
  items         Json
  total         Float
  status        ShopOrderStatus @default(PENDING_PAYMENT)
  paymentMethod String?         @map("payment_method")
  paymentStatus String          @default("pending") @map("payment_status")
  receiptUrl    String?         @map("receipt_url")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  user          User?           @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("shop_orders")
}

// ─── Absence System ───────────────────────────────────────────────────────────

enum AbsenceType {
  APPLY        // ≥7 days notice → earns replacement credit
  LATE_NOTICE  // 3-6 days notice → no credit
  ABSENT       // <3 days or no-show → no credit
  MEDICAL      // Pending admin review
}

enum AbsenceStatus {
  APPROVED        // Auto-approved (APPLY type)
  RECORDED        // Auto-recorded (LATE_NOTICE / ABSENT)
  PENDING_REVIEW  // Awaiting admin decision (MEDICAL)
  REVIEWED        // Admin has decided
}

model Absence {
  id                String        @id @default(cuid())
  userId            String        @map("user_id")
  user              User          @relation(fields: [userId], references: [id])
  lessonSessionId   String        @map("lesson_session_id")
  lessonSession     LessonSession @relation(fields: [lessonSessionId], references: [id])
  type              AbsenceType
  status            AbsenceStatus @default(APPROVED)
  reason            String?
  proofUrl          String?       @map("proof_url")
  adminNotes        String?       @map("admin_notes")
  creditAwarded     Boolean       @default(false) @map("credit_awarded")
  reviewedBy        String?       @map("reviewed_by")
  reviewedAt        DateTime?     @map("reviewed_at")
  lessonDate        DateTime      @map("lesson_date")
  appliedAt         DateTime      @default(now()) @map("applied_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  replacementCredit ReplacementCredit?

  @@unique([userId, lessonSessionId])
  @@index([userId])
  @@index([lessonSessionId])
  @@index([type])
  @@index([status])
  @@map("absences")
}

model ReplacementCredit {
  id                  String              @id @default(cuid())
  userId              String              @map("user_id")
  user                User                @relation(fields: [userId], references: [id])
  absenceId           String              @unique @map("absence_id")
  absence             Absence             @relation(fields: [absenceId], references: [id])
  usedAt              DateTime?           @map("used_at")
  expiresAt           DateTime            @map("expires_at")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  replacementBooking  ReplacementBooking?

  @@index([userId])
  @@map("replacement_credits")
}

// ─── Replacement Booking System ───────────────────────────────────────────────

enum ReplacementBookingStatus {
  CONFIRMED
  CANCELLED
  COMPLETED
}

model ReplacementBooking {
  id                  String                    @id @default(cuid())
  userId              String                    @map("user_id")
  user                User                      @relation(fields: [userId], references: [id])
  replacementCreditId String                    @unique @map("replacement_credit_id")
  replacementCredit   ReplacementCredit         @relation(fields: [replacementCreditId], references: [id])
  lessonSessionId     String                    @map("lesson_session_id")
  lessonSession       LessonSession             @relation(fields: [lessonSessionId], references: [id])
  status              ReplacementBookingStatus  @default(CONFIRMED)
  createdAt           DateTime                  @default(now()) @map("created_at")
  updatedAt           DateTime                  @updatedAt @map("updated_at")

  @@index([userId])
  @@index([lessonSessionId])
  @@map("replacement_bookings")
}

// ─── Staff / Teacher System ──────────────────────────────────────────────────

model Teacher {
  id        String   @id @default(cuid())
  name      String
  userId    String?  @unique @map("user_id")
  user      User?    @relation(fields: [userId], references: [id])
  phone     String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  payRates       TeacherPayRate[]
  lessonSessions LessonSession[]

  @@map("teachers")
}

model TeacherPayRate {
  id         String   @id @default(cuid())
  teacherId  String   @map("teacher_id")
  teacher    Teacher  @relation(fields: [teacherId], references: [id])
  lessonType String   @map("lesson_type")
  rate       Float
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@unique([teacherId, lessonType])
  @@map("teacher_pay_rates")
}

// ─── Gamification System ──────────────────────────────────────────────────────

enum PlayerGroup {
  ELITE
  ACTIVE
}

model GameSession {
  id          String              @id @default(cuid())
  date        DateTime
  courtId     Int?                @map("court_id")
  court       Court?              @relation(fields: [courtId], references: [id])
  notes       String?
  createdBy   String              @map("created_by")
  createdByUser User              @relation(fields: [createdBy], references: [id])
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")
  attendances SessionAttendance[]
  matches     Match[]

  @@index([date])
  @@map("game_sessions")
}

model SessionAttendance {
  id        String      @id @default(cuid())
  sessionId String      @map("session_id")
  session   GameSession @relation(fields: [sessionId], references: [id])
  userId    String      @map("user_id")
  user      User        @relation(fields: [userId], references: [id])
  createdAt DateTime    @default(now()) @map("created_at")

  @@unique([sessionId, userId])
  @@index([userId])
  @@map("session_attendances")
}

model Match {
  id          String        @id @default(cuid())
  sessionId   String        @map("session_id")
  session     GameSession   @relation(fields: [sessionId], references: [id])
  matchNumber Int           @map("match_number")
  team1Score  Int           @map("team1_score")
  team2Score  Int           @map("team2_score")
  createdAt   DateTime      @default(now()) @map("created_at")
  players     MatchPlayer[]

  @@unique([sessionId, matchNumber])
  @@index([sessionId])
  @@map("matches")
}

model MatchPlayer {
  id        String  @id @default(cuid())
  matchId   String  @map("match_id")
  match     Match   @relation(fields: [matchId], references: [id])
  userId    String  @map("user_id")
  user      User    @relation(fields: [userId], references: [id])
  team      Int
  isWinner  Boolean @map("is_winner")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([matchId])
  @@index([userId])
  @@map("match_players")
}

model PlayerPoints {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  user              User     @relation(fields: [userId], references: [id])
  month             String   // YYYY-MM format
  attendancePoints  Float    @default(0) @map("attendance_points")
  gamesPoints       Float    @default(0) @map("games_points")
  winsPoints        Float    @default(0) @map("wins_points")
  bonusPoints       Float    @default(0) @map("bonus_points")
  totalPoints       Float    @default(0) @map("total_points")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([userId, month])
  @@index([month])
  @@map("player_points")
}

model PlayerProfile {
  id               String      @id @default(cuid())
  userId           String      @unique @map("user_id")
  user             User        @relation(fields: [userId], references: [id])
  group            PlayerGroup @default(ACTIVE)
  groupOverride    Boolean     @default(false) @map("group_override")
  winRate          Float       @default(0) @map("win_rate")
  totalGames       Int         @default(0) @map("total_games")
  totalWins        Int         @default(0) @map("total_wins")
  currentStreak    Int         @default(0) @map("current_streak")
  bestStreak       Int         @default(0) @map("best_streak")
  consecutiveWeeks Int         @default(0) @map("consecutive_weeks")
  lastSessionDate  DateTime?   @map("last_session_date")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  @@map("player_profiles")
}
