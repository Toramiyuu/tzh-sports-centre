// TZH Badminton Booking System - Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  uid               BigInt             @unique @default(autoincrement())
  email             String             @unique
  passwordHash      String             @map("password_hash")
  name              String
  phone             String             @unique
  emergencyContact  String?            @map("emergency_contact")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  bookings          Booking[]
  recurringBookings RecurringBooking[]
  monthlyPayments   MonthlyPayment[]

  // Admin flag (in addition to hardcoded list)
  isAdmin           Boolean            @default(false) @map("is_admin")

  // Member/Student fields
  isMember          Boolean            @default(false) @map("is_member")
  skillLevel        String?            @map("skill_level") // beginner, intermediate, advanced
  lessonSessions    LessonSession[]    @relation("StudentLessons")
  lessonRequests    LessonRequest[]
  notifications     Notification[]

  // Profile & Account settings
  creditBalance         Float     @default(0) @map("credit_balance")
  notifyBookingConfirm  Boolean   @default(true) @map("notify_booking_confirm")
  notifyBookingReminder Boolean   @default(true) @map("notify_booking_reminder")
  notifyCancellation    Boolean   @default(true) @map("notify_cancellation")
  notifyLessonUpdates   Boolean   @default(true) @map("notify_lesson_updates")

  // Email change verification
  pendingEmail      String?   @map("pending_email")
  emailVerifyToken  String?   @map("email_verify_token")
  emailVerifyExpiry DateTime? @map("email_verify_expiry")

  // Account deletion
  deletedAt         DateTime? @map("deleted_at")

  @@map("users")
}

model Court {
  id                Int                @id @default(autoincrement())
  name              String
  description       String?
  isActive          Boolean            @default(true) @map("is_active")
  hourlyRate        Float              @map("hourly_rate")
  bookings          Booking[]
  recurringBookings RecurringBooking[]
  lessonSessions    LessonSession[]

  @@map("courts")
}

model Booking {
  id              String   @id @default(cuid())
  userId          String?  @map("user_id") // Optional - null for guest bookings
  courtId         Int      @map("court_id")
  sport           String   @default("badminton") // badminton, pickleball
  bookingDate     DateTime @map("booking_date")
  startTime       String   @map("start_time")
  endTime         String   @map("end_time")
  totalAmount     Float    @map("total_amount")
  status          String   @default("pending") // pending, confirmed, cancelled

  // Payment fields
  paymentStatus   String   @default("pending") @map("payment_status") // pending, paid, failed, refunded
  paymentMethod   String?  @map("payment_method") // card, fpx, grabpay, touchngo
  paymentIntentId String?  @map("payment_intent_id")
  stripeSessionId String?  @map("stripe_session_id")
  paidAt          DateTime? @map("paid_at")

  // Guest booking fields
  guestName       String?  @map("guest_name")
  guestPhone      String?  @map("guest_phone")
  guestEmail      String?  @map("guest_email")
  // Cancellation fields
  cancelledAt     DateTime? @map("cancelled_at")
  creditRefunded  Float?    @map("credit_refunded")

  // Expiration tracking
  expirationWarningSent Boolean   @default(false) @map("expiration_warning_sent")
  expiredAt             DateTime? @map("expired_at")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user  User?  @relation(fields: [userId], references: [id])
  court Court @relation(fields: [courtId], references: [id])

  @@map("bookings")
}

model TimeSlot {
  id          Int    @id @default(autoincrement())
  slotTime    String @map("slot_time") // "09:00", "10:00", etc.
  displayName String @map("display_name") // "9:00 AM", "10:00 AM", etc.

  @@map("time_slots")
}

model RecurringBooking {
  id          String   @id @default(cuid())
  courtId     Int      @map("court_id")
  sport       String   @default("badminton") // badminton, pickleball
  dayOfWeek   Int      @map("day_of_week") // 0=Sunday, 1=Monday, etc.
  startTime   String   @map("start_time") // "09:00", "10:00", etc.
  endTime     String   @map("end_time")
  startDate   DateTime @map("start_date") // When recurring starts
  endDate     DateTime? @map("end_date") // When recurring ends (null = indefinite)

  // Label for admin bookings (e.g., "Social Games", "Training")
  label       String?

  // For customer recurring bookings
  userId      String?  @map("user_id")
  guestName   String?  @map("guest_name")
  guestPhone  String?  @map("guest_phone")

  // Pricing for monthly invoices
  hourlyRate  Float?   @map("hourly_rate") // Rate per hour (if different from court default)

  // Who created this (admin email or null)
  createdBy   String?  @map("created_by")
  isActive    Boolean  @default(true) @map("is_active")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  court    Court  @relation(fields: [courtId], references: [id])
  user     User?  @relation(fields: [userId], references: [id])
  payments RecurringBookingPayment[]

  @@map("recurring_bookings")
}

// Monthly payment tracking for recurring bookings
model RecurringBookingPayment {
  id                  String    @id @default(cuid())
  recurringBookingId  String    @map("recurring_booking_id")
  month               Int       // 1-12
  year                Int
  amount              Float     // Total amount for the month
  sessionsCount       Int       @map("sessions_count") // Number of sessions in this month
  status              String    @default("pending") // pending, paid
  paidAt              DateTime? @map("paid_at")
  paymentMethod       String?   @map("payment_method") // cash, tng, bank_transfer, stripe
  notes               String?

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  recurringBooking    RecurringBooking @relation(fields: [recurringBookingId], references: [id], onDelete: Cascade)

  @@unique([recurringBookingId, month, year])
  @@map("recurring_booking_payments")
}

// Coach availability for lessons (when coach is free to teach)
model CoachAvailability {
  id          String    @id @default(cuid())
  dayOfWeek   Int       @map("day_of_week") // 0=Sunday, 1=Monday, etc.
  startTime   String    @map("start_time") // "09:00", "09:30", etc.
  endTime     String    @map("end_time")
  isRecurring Boolean   @default(true) @map("is_recurring")
  specificDate DateTime? @map("specific_date") // For one-time availability
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("coach_availability")
}

// Booked lesson sessions
model LessonSession {
  id          String   @id @default(cuid())
  courtId     Int      @map("court_id")
  lessonDate  DateTime @map("lesson_date")
  startTime   String   @map("start_time") // "09:00", "09:30", etc.
  endTime     String   @map("end_time")

  // Lesson type: "1-to-1", "1-to-2", "1-to-3", "1-to-4", "small-kids-beginners", etc.
  lessonType  String   @map("lesson_type")
  billingType String   @default("per_session") @map("billing_type") // per_session, monthly
  duration    Float    // Duration in hours (1.5 or 2)
  price       Float    // Total price for the session (or pro-rated monthly)

  // Students in this session (can be multiple for group lessons)
  students    User[]   @relation("StudentLessons")

  status      String   @default("scheduled") // scheduled, completed, cancelled
  notes       String?  // Coach notes about the session

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  court       Court    @relation(fields: [courtId], references: [id])

  @@map("lesson_sessions")
}

// Monthly payment tracking by User (for all bookings in a month)
model MonthlyPayment {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  month           Int       // 1-12
  year            Int

  // Totals (computed when created/updated)
  totalAmount     Float     @map("total_amount")     // Total due for the month
  paidAmount      Float     @default(0) @map("paid_amount")  // Amount paid so far
  bookingsCount   Int       @map("bookings_count")   // Number of bookings
  totalHours      Float     @map("total_hours")      // Total hours booked

  // Payment tracking
  status          String    @default("unpaid") // unpaid, partial, paid

  // Audit fields
  markedPaidBy    String?   @map("marked_paid_by")   // Admin email who marked paid
  markedPaidAt    DateTime? @map("marked_paid_at")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user            User      @relation(fields: [userId], references: [id])
  transactions    PaymentTransaction[]

  @@unique([userId, month, year])
  @@map("monthly_payments")
}

// Individual payment transactions (supports partial payments)
model PaymentTransaction {
  id                String    @id @default(cuid())
  monthlyPaymentId  String    @map("monthly_payment_id")
  amount            Float     // Amount of this payment
  paymentMethod     String    @map("payment_method") // cash, tng, bank_transfer, card, duitnow
  reference         String?   // Transaction reference number
  notes             String?

  // Audit fields
  recordedBy        String    @map("recorded_by")   // Admin email who recorded
  recordedAt        DateTime  @default(now()) @map("recorded_at")

  monthlyPayment    MonthlyPayment @relation(fields: [monthlyPaymentId], references: [id], onDelete: Cascade)

  @@map("payment_transactions")
}

// Member requests for lessons (pending approval)
model LessonRequest {
  id                String   @id @default(cuid())
  memberId          String   @map("member_id")
  requestedDate     DateTime @map("requested_date")
  requestedTime     String   @map("requested_time") // "09:00", "09:30", etc.
  lessonType        String   @map("lesson_type") // "1-to-1", "1-to-2", etc.
  requestedDuration Float    @default(1.5) @map("requested_duration") // Duration in hours (1.5, 2, 2.5, etc.)

  status          String   @default("pending") // pending, approved, rejected, changed
  adminNotes      String?  @map("admin_notes") // Notes from coach (e.g., suggest different time)
  suggestedTime   String?  @map("suggested_time") // If coach suggests different time

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  member          User     @relation(fields: [memberId], references: [id])

  @@map("lesson_requests")
}

// In-app notifications for users
model Notification {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  type        String   // booking_warning, booking_expired, booking_confirmed, etc.
  title       String
  message     String
  link        String?  // Optional link to related page
  isRead      Boolean  @default(false) @map("is_read")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// Trial lesson requests from potential students
model TrialRequest {
  id                  String    @id @default(cuid())
  name                String
  phone               String
  email               String?
  preferredLessonType String    @map("preferred_lesson_type") // 1-to-1, group-kids, adult-group, etc.
  preferredDate       DateTime? @map("preferred_date")
  preferredTime       String?   @map("preferred_time") // "09:00", "14:00", etc.
  message             String?   // Additional notes from the requester

  // Admin management
  status              String    @default("new") // new, contacted, scheduled, converted, not_interested
  adminNotes          String?   @map("admin_notes")
  contactedAt         DateTime? @map("contacted_at")
  handledBy           String?   @map("handled_by") // Admin email who handled

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@map("trial_requests")
}
